name: Build Catalyst

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      
    - name: Download and Install Hytale Server
      run: |
        mkdir downloader
        cd downloader
        wget https://downloader.hytale.com/hytale-downloader.zip
        unzip hytale-downloader.zip
        mv hytale-downloader-linux-amd64 hytale-downloader
        chmod +x hytale-downloader
        
        # Download server files
        ./hytale-downloader
        
        # Unzip the downloaded game files (ignoring the downloader zip itself)
        # The downloader saves a versioned zip (e.g. 2026...zip)
        GAME_ZIP=$(find . -maxdepth 1 -name "*.zip" ! -name "hytale-downloader.zip" | head -n 1)
        if [ -n "$GAME_ZIP" ]; then
           echo "Extracting $GAME_ZIP..."
           unzip -q "$GAME_ZIP"
        fi
        
        # Find the jar recursively (structure might be release/package/game/latest/Server or similar)
        JAR_PATH=$(find . -name "HytaleServer.jar" | head -n 1)
        
        if [ -f "$JAR_PATH" ]; then
           echo "Found jar at: $JAR_PATH"
           # Create a custom POM to avoid parent resolution issues (since the jar likely has an internal POM referencing a missing parent)
           echo '<?xml version="1.0" encoding="UTF-8"?><project xmlns="http://maven.apache.org/POM/4.0.0" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><modelVersion>4.0.0</modelVersion><groupId>com.hypixel.hytale</groupId><artifactId>HytaleServer</artifactId><version>1.0-SNAPSHOT</version><description>Hytale Server</description></project>' > hytale-server.pom
           
           mvn install:install-file -Dfile="$JAR_PATH" -DpomFile=hytale-server.pom -Dpackaging=jar
        else
            echo "Error: HytaleServer.jar not found after extraction!"
            ls -R
            exit 1
        fi

    - name: Build with Gradle
      run: ./gradlew build

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Catalyst-Build
        path: build/libs/*.jar
